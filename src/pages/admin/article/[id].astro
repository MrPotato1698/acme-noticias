---
import Layout from "@/layouts/Layout.astro";
import { supabase } from "@/db/supabase";

const { id } = Astro.params;

if (!id) {
    throw new Error("ID de articulo no proporcionado.");
}
const { data, error } = await supabase
    .from("article")
    .select(
        `
            title,
            body,
            timestamp,
            author,
            profiles!article_author_fkey(id,full_name,email),
            articlecategories(
            category(
            name, description))
    `,
    )
    .eq("id", Number(id))
    .single();
---

<Layout>
    <div class="flex items-center justify-center">
        <div class="p-8 rounded-lg shadow-md max-w-md w-full">
            <h1 class="text-2xl font-bold mb-6">Cambiar Nombre</h1>

            <!-- Paso 1: paso el id como atributo data-id -->
            <form
                id="formRedactor"
                data-id={id}
                method="POST"
                action="/api/author/editauthors"
            >
                <input type="hidden" name="id" value={id} />
                <label
                    for="nombre"
                    class="block mb-2 text-sm font-medium text-gray-700"
                    >Nombre:</label
                >
                <input
                    type="text"
                    id="nombre"
                    name="nombre"
                    class="w-full px-4 py-2 mb-6 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    required
                />

                <div class="flex justify-between">
                    <button
                        type="submit"
                        class="bg-[var(--color-primary)] text-white px-4 py-2 rounded hover:bg-[var(--color-accent)] cursor-pointer"
                    >
                        Guardar
                    </button>

                    <button
                        type="button"
                        onclick="window.history.back()"
                        class="bg-[var(--color-secondary)] text-white px-4 py-2 rounded hover:bg-[#800f1a] cursor-pointer"
                    >
                        Volver
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Paso 2: listener en JS que lee el id del data-id -->
    <script>
        document
            .getElementById("formRedactor")
            ?.addEventListener("submit", async function (e) {
                e.preventDefault();

                //const form = e.currentTarget as HTMLFormElement;
                //   const id = form.getAttribute('data-id');

                const formulario = document.querySelector(
                    "formRedactor",
                ) as HTMLFormElement;
                const formData = new FormData(formulario); // toma todos los inputs del form

                /* if (!id) {
        alert('No se encontró el ID del redactor');
        return;
      }
  
      const inputNombre = document.getElementById('nombre') as HTMLInputElement;
      if (!inputNombre) {
        alert('El campo nombre no se encontró');
        return;
      }*/

                const response = await fetch("/api/authors/editauthors", {
                    method: "POST",
                    body: formData,
                });

                const result = await response.json();

                if (response.ok) {
                    alert("Nombre actualizado con éxito");
                    // Redirigir o recargar si quieres
                } else {
                    alert("Error: " + (result.error || "Error desconocido"));
                }
            });
    </script>
</Layout>
